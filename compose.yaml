services:
  # 1. Frontend (React + Nginx)
  # インターネットからの入り口を一手に引き受ける
  frontend:
    build: ./frontend
    container_name: puranemone_frontend
    restart: unless-stopped
    depends_on:
      - backend
    # 外部(Host)へのポート開放は不要。Tunnelが内部で接続するため。

  # 2. Backend (Rust + Axum)
  # Frontendからのリクエスト(/api)のみを処理する
  backend:
    build: ./backend
    container_name: puranemone_backend
    restart: unless-stopped
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}

  # 3. Database (PostgreSQL)
  db:
    image: postgres:16-alpine
    container_name: puranemone_db
    restart: unless-stopped
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./setup.sql:/docker-entrypoint-initdb.d/setup.sql:ro    # 初回起動時にDBをセットアップするSQLファイル
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}

  # 4. Ingress (Cloudflare Tunnel)
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: puranemone_tunnel
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}